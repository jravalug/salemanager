<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Bookkeeping Management" />
    <meta
      name="keywords"
      content="Bookkeeping, Account, Finance, Sales, Spenses, Management"
    />
    <meta name="author" content="Jose Abadia" />
    {# icon same as svg logo#}
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='images/output_logo.svg') }}"
    />
    <title>
      {% block title %}
        Bookkeeply | Gestión Integral
      {% endblock title %}
    </title>
    <!-- Enlazar el archivo CSS compilado de Tailwind -->
    <link
      href="{{ url_for('static', filename='css/styles.css') }}"
      rel="stylesheet"
    />

    {% block vendor_styles %}
    {% endblock vendor_styles %}

    <script>
      // On page load or when changing themes, best to add inline in `head` to avoid FOUC
      if (
        localStorage.getItem("color-theme") === "dark" ||
        (!("color-theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <!-- Script de Flowbite -->
    <script
      src="{{ url_for('main.node_modules', filename='flowbite/dist/flowbite.min.js') }}"
      defer
    ></script>
    {% block vendor_javascript %}
    {% endblock vendor_javascript %}
  </head>
  <body class="dark:bg-gray-900 antialiased">
    {# Importar macros de iconos #}
    {% from '_icons.html' import building, receipt, box, inventory, stats, list as list_icon %}
    <!-- Barra de navegación fija -->
    <header
      class="bg-white dark:bg-gray-900 fixed w-full z-20 top-0 start-0 border-b border-gray-200 dark:border-gray-600"
    >
      <div
        class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4"
      >
        <a
          href="{{ url_for('main.index') }}"
          class="flex items-center space-x-3 rtl:space-x-reverse"
        >
          <img
            src="{{ url_for('static', filename='images/output_logo.svg') }}"
            class="h-8"
            alt="SALEManager logo"
          />
          <span
            class="self-center text-2xl font-extrabold whitespace-nowrap text-logo-light dark:text-logo-dark"
            >Bookkeeply</span
          >
        </a>
        <div class="flex md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
          <!-- Mobile sidebar open button -->
          <button
            id="mobile-sidebar-open"
            class="lg:hidden text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 me-2"
            aria-label="Open sidebar"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
          <button
            id="theme-toggle"
            type="button"
            class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5"
          >
            <svg
              id="theme-toggle-dark-icon"
              class="hidden w-5 h-5"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
              ></path>
            </svg>
            <svg
              id="theme-toggle-light-icon"
              class="hidden w-5 h-5"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                fill-rule="evenodd"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Contenido principal: layout con sidebar a la izquierda y área de contenido a la derecha -->
    <main class="max-w-screen-xl mx-auto px-4 py-6 mt-20 mb-20">
      <div class="lg:flex lg:gap-6">
        <!-- Sidebar izquierdo -->
        {% if business %}

          {# Compute canonical hrefs so we can compare with request_path for active state #}
          {% set href_dashboard = url_for('business.dashboard', business_id=business.id) %}
          {% set href_sales = url_for('sale.sales', business_id=business.id) %}
          {% set href_products = url_for('product.list', business_id=business.id) %}
          {% set href_inventory = url_for('inventory.item_list', business_id=business.id) %}
          {% set href_monthly_sales_by_date = url_for('report.monthly_sales_by_date', business_id=business.id) %}
          {% set href_monthly_sales_by_product = url_for('report.monthly_sales_by_produc', business_id=business.id) %}
          {% set href_inventory_consumption = url_for('report.inventory_consumption_view', business_id=business.id) %}
          {% set href_ipv_report = url_for('report.ipv_report', business_id=business.id) %}
          <aside
            id="principal-sidebar"
            class="hidden lg:block w-full lg:w-72 shrink-0"
          >
            <div
              class="rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-200"
            >
              <div class="flex items-center gap-3 mb-6">
                {% if business.logo %}
                  <img
                    src="{{ url_for('static', filename=business.logo) }}"
                    alt="Logo de {{ business.name }}"
                    class="h-12 w-12 rounded-md object-cover"
                  />
                {% endif %}
                <div>
                  <div class="font-semibold">Jose Angel Perez</div>
                  <div class="text-sm text-gray-400">{{ business.name }}</div>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-3 mb-6">
                <button
                  class="bg-indigo-600 text-white rounded-md py-2 px-3 text-sm"
                >
                  Profile
                </button>
                <button
                  class="bg-purple-600 text-white rounded-md py-2 px-3 text-sm"
                >
                  Gifts
                </button>
                <button
                  class="bg-emerald-600 text-white rounded-md py-2 px-3 text-sm"
                >
                  Wallet
                </button>
              </div>

              <ul class="space-y-2 font-medium">
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_dashboard) %}
                  <a
                    class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                    href="{{ href_dashboard }}"
                    >{{ receipt('w-5 h-5') }} Dashboard</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_sales) %}
                  <a
                    class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                    href="{{ href_sales }}"
                    >{{ receipt('w-5 h-5') }} Ventas</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_products) %}
                  <a
                    class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                    href="{{ href_products }}"
                    >{{ box('w-5 h-5') }} Productos</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_inventory) %}
                  <a
                    class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                    href="{{ href_inventory }}"
                    >{{ inventory('w-5 h-5') }} Inventarios</a
                  >
                </li>
                <li>
                  <button
                    type="button"
                    class="flex items-center w-full p-2 text-base text-gray-900 transition duration-75 rounded group hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                    aria-controls="dropdown-report"
                    data-collapse-toggle="dropdown-report"
                  >
                    {{ stats('shrink-0 w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white') }}
                    <span
                      class="flex-1 ms-3 text-left rtl:text-right whitespace-nowrap"
                      >Reportes</span
                    >
                    <svg
                      class="w-3 h-3"
                      aria-hidden="true"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 10 6"
                    >
                      <path
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="m1 1 4 4 4-4"
                      />
                    </svg>
                  </button>
                  {# Hacer que este abierto si el request_path comienza por alguno de los reportes #}
                  {%
                    set is_report_active = request_path is not none and (
                      request_path.startswith(href_monthly_sales_by_date) or
                      request_path.startswith(href_monthly_sales_by_product) or
                      request_path.startswith(href_inventory_consumption) or
                      request_path.startswith(href_ipv_report)
                    )
                  %}
                  <ul
                    id="dropdown-report"
                    class="{{ 'block' if is_report_active else 'hidden' }} py-2 space-y-2"
                  >
                    <li>
                      {% set is_active = request_path is not none and request_path.startswith(href_monthly_sales_by_date) %}
                      <a
                        href="{{ href_monthly_sales_by_date }}"
                        class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                        >Ventas por fecha</a
                      >
                    </li>
                    <li>
                      {% set is_active = request_path is not none and request_path.startswith(href_monthly_sales_by_product) %}
                      <a
                        href="{{ href_monthly_sales_by_product }}"
                        class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                        >Ventas por Producto</a
                      >
                    </li>
                    <li>
                      {% set is_active = request_path is not none and request_path.startswith(href_ipv_report) %}
                      <a
                        href="{{ href_ipv_report }}"
                        class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                        >Inventario a Precio de Venta</a
                      >
                    </li>
                    <li>
                      {% set is_active = request_path is not none and request_path.startswith(href_inventory_consumption) %}
                      <a
                        href="{{ href_inventory_consumption }}"
                        class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                        >Consumo de Materias Primas</a
                      >
                    </li>
                  </ul>
                </li>
              </ul>

              <div class="mt-6 border-t border-gray-700 pt-4">
                <a
                  class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"
                  href="#"
                  >Settings</a
                >
                <a
                  class="flex items-center gap-3 p-2 rounded text-red-400 hover:bg-gray-700 mt-2"
                  href="#"
                  >Log out</a
                >
              </div>
            </div>
          </aside>
        {% endif %}
        <!-- Área de contenido derecha -->
        <div class="flex-1">
          <!-- Mensajes flash (moved here so they appear above the card) -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div
                  id="toast-{{ category }}"
                  class="mb-4 w-full max-w-2xl p-4 rounded-lg shadow-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200"
                >
                  <div class="font-medium">{{ message }}</div>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <!-- Card placeholder a la derecha -->
          {% block content %}
          {% endblock content %}
        </div>
      </div>
    </main>
    <div
      id="mobile-sidebar-backdrop"
      class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"
    ></div>
    <aside
      id="mobile-sidebar"
      class="fixed left-0 top-0 h-full w-72 bg-gray-800 dark:bg-gray-900 text-gray-100 z-50 transform -translate-x-full transition-transform duration-200 lg:hidden"
    >
      {% if business %}
        <div class="p-4">
          <div class="flex items-center gap-3 mb-6">
            {% if business and business.logo %}
              <img
                src="{{ url_for('static', filename=business.logo) }}"
                alt="logo"
                class="h-12 w-12 rounded-md object-cover"
              />
            {% else %}
              <img
                src="{{ url_for('static', filename='images/output_logo.svg') }}"
                alt="logo"
                class="h-12 w-12 rounded-md object-cover"
              />
            {% endif %}
            <div>
              <div class="font-semibold">
                {% if business %}{{ business.name }}{% else %}Usuario{% endif %}
              </div>
              <div class="text-sm text-gray-400">
                {% if business %}{{ business.name }}{% else %}email@example.com{% endif %}
              </div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-3 mb-6">
            <button
              class="bg-indigo-600 text-white rounded-md py-2 px-3 text-sm"
            >
              Profile
            </button>
            <button
              class="bg-purple-600 text-white rounded-md py-2 px-3 text-sm"
            >
              Gifts
            </button>
            <button
              class="bg-emerald-600 text-white rounded-md py-2 px-3 text-sm"
            >
              Wallet
            </button>
          </div>
          {# TODO: CREATE THE LINK FOR PAGES #}
          <nav class="space-y-3 text-sm">
            <div>
              {% set is_active = request_path is not none and request_path.startswith(href_dashboard) %}
              <a
                class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                href="{{ href_dashboard }}"
                >{{ receipt('w-5 h-5') }} Dashboard</a
              >
            </div>
            <div>
              {% set is_active = request_path is not none and request_path.startswith(href_sales) %}
              <a
                class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                href="{{ href_sales }}"
                >{{ receipt('w-5 h-5') }} Ventas</a
              >
            </div>
            <div>
              {% set is_active = request_path is not none and request_path.startswith(href_products) %}
              <a
                class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                href="{{ href_products }}"
                >{{ box('w-5 h-5') }} Productos</a
              >
            </div>
            <div>
              {% set is_active = request_path is not none and request_path.startswith(href_inventory) %}
              <a
                class="flex items-center gap-3 p-2 rounded hover:bg-gray-700 {{ 'text-blue-500' if is_active else '' }}"
                href="{{ href_inventory }}"
                >{{ inventory('w-5 h-5') }} Inventarios</a
              >
            </div>
            <div>
              <button
                type="button"
                class="flex items-center w-full p-2 text-base text-gray-900 transition duration-75 rounded group hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                aria-controls="dropdown-report"
                data-collapse-toggle="dropdown-report"
              >
                {{ stats('shrink-0 w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white') }}
                <span
                  class="flex-1 ms-3 text-left rtl:text-right whitespace-nowrap"
                  >Reportes</span
                >
                <svg
                  class="w-3 h-3"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 10 6"
                >
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 4 4 4-4"
                  />
                </svg>
              </button>
              {# Hacer que este abierto si el request_path comienza por alguno de los reportes #}
              {%
                set is_report_active = request_path is not none and (
                  request_path.startswith(href_monthly_sales_by_date) or
                  request_path.startswith(href_monthly_sales_by_product) or
                  request_path.startswith(href_inventory_consumption) or
                  request_path.startswith(href_ipv_report)
                )
              %}
              <ul
                id="dropdown-report"
                class="{{ 'block' if is_report_active else 'hidden' }} py-2 space-y-2"
              >
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_monthly_sales_by_date) %}
                  <a
                    href="{{ href_monthly_sales_by_date }}"
                    class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                    >Ventas por fecha</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_monthly_sales_by_product) %}
                  <a
                    href="{{ href_monthly_sales_by_product }}"
                    class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                    >Ventas por Producto</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_ipv_report) %}
                  <a
                    href="{{ href_ipv_report }}"
                    class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                    >Inventario a Precio de Venta</a
                  >
                </li>
                <li>
                  {% set is_active = request_path is not none and request_path.startswith(href_inventory_consumption) %}
                  <a
                    href="{{ href_inventory_consumption }}"
                    class="flex items-center w-full p-2 text-gray-900 transition duration-75 rounded pl-11 group hover:bg-gray-100  dark:hover:bg-gray-700 {{ 'dark:text-blue-500' if is_active else 'dark:text-white' }}"
                    >Consumo de Materias Primas</a
                  >
                </li>
              </ul>
            </div>
          </nav>
          <div class="mt-6 border-t border-gray-700 pt-4">
            <a
              class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"
              href="#"
              >Settings</a
            >
            <a
              class="flex items-center gap-3 p-2 rounded text-red-400 hover:bg-gray-700 mt-2"
              href="#"
              >Log out</a
            >
          </div>
        </div>
      {% else %}

      {% endif %}
    </aside>

    <script>
      (function () {
        const openBtn = document.getElementById("mobile-sidebar-open");
        const backdrop = document.getElementById("mobile-sidebar-backdrop");
        const sidebar = document.getElementById("mobile-sidebar");

        function open() {
          sidebar.classList.remove("-translate-x-full");
          backdrop.classList.remove("hidden");
        }

        function close() {
          sidebar.classList.add("-translate-x-full");
          backdrop.classList.add("hidden");
        }

        if (openBtn) openBtn.addEventListener("click", open);
        if (backdrop) backdrop.addEventListener("click", close);

        // close on escape
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") close();
        });
      })();
    </script>

    <!-- Pie de página fijo -->
    <footer
      class="bg-white shadow-md fixed bottom-0 left-0 right-0 py-4 dark:bg-gray-800 dark:text-gray-300"
    >
      <div
        class="container mx-auto px-4 text-center text-gray-600 dark:text-gray-300"
      >
        © {{ now().year }} Bookkeeply | Grupo CONFIANZA.
      </div>
    </footer>

    <!-- Script para cambiar entre light mode y dark mode -->
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    {% block custom_javascript %}
    {% endblock custom_javascript %}
  </body>
</html>
